<!DOCTYPE html>
<html lang="pt-br">

<head>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload de Vídeos</title>
    <style>
        /* Customização do autocomplete */
        .ui-autocomplete {
            background-color: #1f2937;
            border: 1px solid #374151;
            color: white;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px 0;
            font-size: 14px;
            border-radius: 6px;
        }

        .ui-menu-item {
            padding: 5px 10px;
        }

        .ui-menu-item:hover,
        .ui-menu-item .ui-state-active {
            background: #374151;
            border: none;
            color: white;
        }

        .ui-helper-hidden-accessible {
            display: none;
        }

        .model-tag {
            display: inline-flex;
            align-items: center;
            background: #4b5563;
            color: white;
            padding: 2px 10px;
            margin: 3px;
            border-radius: 15px;
            font-size: 14px;
        }

        .model-tag .remove {
            margin-left: 6px;
            cursor: pointer;
            color: #e5e7eb;
            font-weight: bold;
        }

        .model-tag .remove:hover {
            color: #f87171;
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen p-4">
    <div class="max-w-3xl mx-auto">
        <h1 class="text-2xl font-bold mb-6 text-red-500">Upload de Vídeos</h1>

        <form action="{{ url_for('main.upload_video', _external=False) }}" method="POST" enctype="multipart/form-data"
            class="space-y-4">
            
            <!-- Seção de modelos com autocomplete -->
            <div>
                <label for="model-search" class="block text-gray-300 text-sm mb-1">Modelos:</label>
                <div class="relative">
                    <input type="text" id="model-search" name="models[]"
                        class="w-full px-4 py-2 rounded-md bg-gray-800 border border-gray-600 focus:border-red-500 focus:outline-none"
                        placeholder="Digite o nome da modelo...">
                    <p class="text-xs text-gray-400 mt-1">Digite para buscar modelos existentes ou criar novas</p>
                </div>
                
                <!-- Container para exibir as modelos selecionadas -->
                <div id="selected-models" class="mt-3 flex flex-wrap"></div>
                
                <!-- Campo hidden que armazenará os nomes das modelos para envio -->
                <div id="model-inputs"></div>
            </div>

            <!-- Upload dos vídeos -->
            <div id="drop-zone" class="relative border-2 border-dashed border-gray-500 rounded p-6 text-center cursor-pointer hover:border-red-500 transition">
                <p class="text-gray-400">Arraste e solte os arquivos aqui ou clique para selecionar</p>
                <input 
                type="file" 
                name="videos" 
                id="videos" 
                accept="video/*" 
                multiple 
                required
                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                >
            </div>

            <!-- Lista de arquivos com botão remover -->
            <div id="file-list" class="space-y-2 mt-2"></div>

            <!-- Campos dinâmicos de título e tags -->
            <div id="video-details"></div>

            <!-- Botão de envio -->
            <div>
                <button type="submit"
                    class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded font-semibold shadow">
                    Enviar Vídeos
                </button>
            </div>
        </form>
    </div>

    <script>
        const availableTags = JSON.parse('{{ tags | tojson | safe }}');

        document.addEventListener('DOMContentLoaded', function () {
            const fileInput = document.getElementById("videos");
            const fileList = document.getElementById("file-list");
            const detailsContainer = document.getElementById("video-details");
            const modelSearch = document.getElementById("model-search");
            const selectedModels = document.getElementById("selected-models");
            const modelInputs = document.getElementById("model-inputs");
            
            let dt = new DataTransfer();
            let selectedModelsList = []; // Array para armazenar as modelos selecionadas

            // Inicializar autocomplete com jQuery UI
            $(modelSearch).autocomplete({
                source: function(request, response) {
                    $.ajax({
                        url: "{{ url_for('main.autocomplete_modelos') }}",
                        dataType: "json",
                        data: { q: request.term },
                        success: function(data) {
                            // Filtrar modelos já selecionadas
                            const filteredData = data.filter(model => !selectedModelsList.includes(model));
                            response(filteredData);
                        }
                    });
                },
                minLength: 1,
                select: function(event, ui) {
                    addModel(ui.item.value);
                    $(this).val('');
                    return false;
                }
            }).on('keypress', function(e) {
                // Adicionar modelo quando pressionar Enter
                if (e.which === 13) {
                    e.preventDefault();
                    const value = $(this).val().trim();
                    if (value && !selectedModelsList.includes(value)) {
                        addModel(value);
                        $(this).val('');
                    }
                }
            });

            // Função para adicionar uma modelo à lista de selecionadas
            function addModel(modelName) {
                if (!modelName || selectedModelsList.includes(modelName)) return;
                
                selectedModelsList.push(modelName);
                updateModelDisplay();
            }

            // Função para remover uma modelo da lista de selecionadas
            function removeModel(modelName) {
                const index = selectedModelsList.indexOf(modelName);
                if (index > -1) {
                    selectedModelsList.splice(index, 1);
                    updateModelDisplay();
                }
            }

            // Atualizar a exibição das modelos selecionadas e os inputs hidden
            function updateModelDisplay() {
                // Limpar contêineres
                selectedModels.innerHTML = '';
                modelInputs.innerHTML = '';
                
                // Adicionar tags visuais para cada modelo
                selectedModelsList.forEach((model, index) => {
                    // Criar tag visual
                    const tag = document.createElement('span');
                    tag.className = 'model-tag';
                    tag.innerHTML = `${model} <span class="remove" data-model="${model}">&times;</span>`;
                    selectedModels.appendChild(tag);
                    
                    // Criar input hidden para envio no formulário
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'models[]';
                    input.value = model;
                    modelInputs.appendChild(input);
                });
                
                // Adicionar event listeners para remover modelos
                document.querySelectorAll('.model-tag .remove').forEach(btn => {
                    btn.addEventListener('click', function() {
                        removeModel(this.getAttribute('data-model'));
                    });
                });
            }

            function generateVideoDetails() {
                detailsContainer.innerHTML = "";
                Array.from(fileInput.files).forEach((file, index) => {
                    const tagOptions = availableTags.map(tag => `
                        <label class="mr-2">
                            <input type="checkbox" name="tags_${index}_${tag.id}" value="${tag.id}">
                            ${tag.name}
                        </label>
                    `).join('');

                    const wrapper = document.createElement("div");
                    wrapper.innerHTML = `
                        <div class="border border-gray-700 p-4 rounded mb-4">
                            <p class="font-semibold text-white">${file.name}</p>
                            <label for="title_${index}" class="block text-sm text-gray-300 mt-2">Título:</label>
                            <input type="text" name="title_${index}" id="title_${index}" placeholder="Título do vídeo" value="${file.name}" required
                                class="w-full px-2 py-1 rounded bg-gray-800 text-white border border-gray-600 mb-2">

                            <label class="block text-sm text-gray-300">Tags (opcional):</label>
                            <div class="flex flex-wrap gap-2 text-sm text-gray-200 mb-2">
                                ${tagOptions}
                            </div>
                        </div>
                    `;
                    detailsContainer.appendChild(wrapper);
                });
            }

            fileInput.addEventListener("change", function () {
                dt = new DataTransfer();
                fileList.innerHTML = "";

                Array.from(fileInput.files).forEach((file, index) => {
                    dt.items.add(file);

                    const item = document.createElement("div");
                    item.className = "flex justify-between items-center bg-gray-800 px-4 py-2 rounded border border-gray-600";

                    item.innerHTML = `
                        <span class="truncate text-sm text-white">${file.name}</span>
                        <button type="button" class="remove-file text-red-400 hover:text-red-200 text-sm ml-4" data-index="${index}">Remover</button>
                    `;

                    fileList.appendChild(item);
                });

                fileInput.files = dt.files;
                generateVideoDetails();
            });

            fileList.addEventListener("click", function (e) {
                if (e.target.classList.contains("remove-file")) {
                    const indexToRemove = parseInt(e.target.getAttribute("data-index"));
                    dt = new DataTransfer();

                    Array.from(fileInput.files).forEach((file, i) => {
                        if (i !== indexToRemove) dt.items.add(file);
                    });

                    fileInput.files = dt.files;

                    fileList.innerHTML = "";
                    Array.from(fileInput.files).forEach((file, index) => {
                        const item = document.createElement("div");
                        item.className = "flex justify-between items-center bg-gray-800 px-4 py-2 rounded border border-gray-600";

                        item.innerHTML = `
                            <span class="truncate text-sm text-white">${file.name}</span>
                            <button type="button" class="remove-file text-red-400 hover:text-red-200 text-sm ml-4" data-index="${index}">Remover</button>
                        `;

                        fileList.appendChild(item);
                    });

                    generateVideoDetails();
                }
            });
        });

        const dropZone = document.getElementById("drop-zone");
    const fileInput = document.getElementById("videos");

    dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("border-red-500", "bg-gray-800");
    });

    dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("border-red-500", "bg-gray-800");
    });

    dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("border-red-500", "bg-gray-800");

        const files = Array.from(e.dataTransfer.files);

        const dt = new DataTransfer();
        for (let file of fileInput.files) dt.items.add(file); // manter arquivos já existentes
        for (let file of files) dt.items.add(file);

        fileInput.files = dt.files;

        // dispara evento change
        const event = new Event("change", { bubbles: true });
        fileInput.dispatchEvent(event);
    });    

    document.getElementById('videos').addEventListener('change', (event) => {
    const arquivos = Array.from(event.target.files);
    const tiposValidos = ['video/mp4', 'video/webm', 'video/x-matroska', 'video/quicktime', 'video/x-msvideo'];

    for (const arquivo of arquivos) {
        if (!tiposValidos.includes(arquivo.type)) {
            alert(`Arquivo inválido: ${arquivo.name}`);
            event.target.value = ''; // Limpa seleção
            break;
        }
    }
});
    </script>
</body>

</html>